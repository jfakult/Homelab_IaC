worker_processes auto;
events { worker_connections 4096; }
http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile on; tcp_nopush on; tcp_nodelay on;
  keepalive_timeout 65;
  server_tokens off;

  # Forward-auth subrequest (internal)
  upstream sso_forward_auth {
    server {{ hostvars[groups['sso'][0]]['ansible_host'] | default('192.168.1.204') }}:80;
    keepalive 32;
  }

  server {
    listen 127.0.0.1:9000;
    server_name _;
    location = /_auth {
      internal;
      proxy_pass              http://sso_forward_auth{{ forward_auth_path }};
      proxy_set_header        X-Original-URL  $scheme://$http_host$request_uri;
      proxy_set_header        X-Forwarded-Host $host;
      proxy_set_header        X-Forwarded-Proto $scheme;
      proxy_set_header        X-Forwarded-Uri  $request_uri;
      proxy_set_header        X-Forwarded-Method $request_method;
      proxy_pass_request_body off;
      proxy_set_header        Content-Length "";
    }
    error_page 401 = @auth_redirect;
    location @auth_redirect {
      return 302 {{ sso_base_url }}/if/flow/default-return?rd=$scheme://$host$request_uri;
    }
  }

  include /etc/nginx/conf.d/*.conf;
}
