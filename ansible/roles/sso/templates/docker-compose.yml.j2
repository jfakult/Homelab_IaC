services:
  authentik:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik
    restart: unless-stopped
    command: server
    depends_on:
      redis:
        condition: service_healthy
    environment:
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      AUTHENTIK_POSTGRESQL__HOST: {{ pg_host }}
      AUTHENTIK_POSTGRESQL__PORT: "{{ pg_port }}"
      AUTHENTIK_POSTGRESQL__NAME: {{ pg_db }}
      AUTHENTIK_POSTGRESQL__USER: {{ pg_user }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ pg_password }}
      AUTHENTIK_BOOTSTRAP_EMAIL: {{ authentik_bootstrap_email }}
      AUTHENTIK_BOOTSTRAP_PASSWORD: {{ authentik_bootstrap_password }}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PORT: "6379"
    ports:
      - "80:9000"
      - "443:9443"

  worker:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    depends_on:
      redis:
        condition: service_healthy
    environment:
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      AUTHENTIK_POSTGRESQL__HOST: {{ pg_host }}
      AUTHENTIK_POSTGRESQL__PORT: "{{ pg_port }}"
      AUTHENTIK_POSTGRESQL__NAME: {{ pg_db }}
      AUTHENTIK_POSTGRESQL__USER: {{ pg_user }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ pg_password }}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PORT: "6379"
    volumes:
      - {{ ak_compose_dir }}/certs:/certs:ro

  redis:
    image: redis:7-alpine
    container_name: authentik-redis
    restart: unless-stopped
    command: ["redis-server","--save","\"\"","--appendonly","no"]
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
      - CMD-SHELL
      - redis-cli ping | grep PONG
      timeout: 3s

  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    restart: unless-stopped
    network_mode: host           # exposes directly on port 9100
    pid: host                    # so it can see host PIDs
    volumes:
      - /:/host:ro,rslave
    command:
      - --path.rootfs=/host
    ports:
      - "9100:9100"              # optional; not needed with host network